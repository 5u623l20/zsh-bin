TODO:

- build on macOS

Disable Windows Defender from Powershell running under Administrator:

  Set-MpPreference -DisableRealtimeMonitoring $true

------------------------

https://www.msys2.org/

------------------------

https://cygwin.com/install.html

There is libpcre-devel but it doesn't have a static library. So no zsh/pcre on cygwin, at least for now.

packages:
  bash
  dash
  autoconf
  binutils
  gcc-core
  gcc-g++
  groff
  make
  libncurses-devel
  libiconv-devel
  perl
  tar
  util-linux
  wget

------------------------

brew install bash autoconf binutils groff make llvm ncurses libiconv util-linux perl wget pcre findutils grep gnu-sed
export PATH="/usr/local/opt/findutils/libexec/gnubin:/usr/local/opt/grep/libexec/gnubin:/usr/local/opt/gnu-sed/libexec/gnubin:$PATH"

xcode-select --install
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"

brew install autoconf make ncurses libiconv pcre

export ZSH_BIN_KERNEL=darwin
export ZSH_BIN_ARCH=x86_64
export ZSH_BIN_CPU=x86-64
outdir=$HOME/build-dir/out
workdir=$HOME/build-dir/work
name=zsh-5.8-"$ZSH_BIN_KERNEL"-"$ZSH_BIN_ARCH"
cpus=10

mkdir "$workdir"/lib
ln -s /usr/local/opt/libiconv/lib/libiconv.a "$workdir"/lib
ln -s /usr/local/opt/ncurses/lib/libncursesw.a "$workdir"/lib
ln -s /usr/local/opt/pcre/lib/libpcre.a "$workdir"/lib

export CPPFLAGS='-I/usr/local/opt/libiconv/include -I/usr/local/opt/ncurses/include -I/usr/local/opt/pcre/include'
export LDFLAGS=-L"$workdir"/lib
export LIBS=-lpcre
export CFLAGS="-march=$ZSH_BIN_CPU $CPPFLAGS"

./configure                             \
  --prefix="$workdir/$name"             \
  --disable-etcdir                      \
  --disable-zshenv                      \
  --disable-zshrc                       \
  --disable-zlogin                      \
  --disable-zprofile                    \
  --disable-zlogout                     \
  --disable-site-fndir                  \
  --disable-site-scriptdir              \
  --enable-cap                          \
  --with-tcsetpgrp                      \
  --disable-dynamic                     \
  --host="$ZSH_BIN_ARCH"                \
  --enable-custom-patchlevel="$name"

# --enable-ldflags=-static              \
# --enable-cflags=-march="$ZSH_BIN_CPU" \

sed_i 's/link=no/link=static/' config.modules
sed_i 's/db_gdbm.mdd link=static/db_gdbm.mdd link=no/' config.modules

make -j "$cpus" install.bin install.modules install.fns
